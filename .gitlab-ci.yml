include:
    - 'templates/.register.yml'
    - 'templates/.deploy.yml'

stages:
    - register
    - deploy
    - generate

variables:
    ACTION:
        description: 'Action à exécuter'
        value: 'none'
        options:
            - 'none'
            - 'generate_article'

generate_article:
    image: node:18-alpine
    stage: generate
    script:
        - npm install

        # Execution du Script js
        - export BRANCH_NAME=$(node generate-article.js $@| tail -n 1)

        # Créer une nouvelle branche
        - git checkout -b "$BRANCH_NAME"

        # Ajouter le nouveau fichier à l'index git
        - git add .

        # Commiter les changements
        - git commit -m "Ajout d'un nouvel article"

        # Pousser la nouvelle branche sur le dépôt distant
        - git push origin "$BRANCH_NAME"

        # Créer une Merge Request
        - curl --request POST \
            --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
            --form "source_branch=$BRANCH_NAME" \
            --form "target_branch=main" \
            --form "title=Ajout d'un nouvel article $BRANCH_NAME" \
            --form "description=Ajout d'un nouvel article $BRANCH_NAME" \
            "https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/merge_requests"
    rules:
        - if: $ACTION == "generate_article"
